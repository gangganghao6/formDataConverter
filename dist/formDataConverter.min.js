import*as path from"path";import*as fs from"fs";import*as crypto from"crypto";const defaultConfig={maxSize:1048576,autoSave:{save:!1,async:!1,path:"./",name:{prefix:"",suffix:"",useMd5:!1}}};function receiveFormData({maxSize:o=defaultConfig.maxSize,autoSave:{save:r=defaultConfig.autoSave.save,async:s=defaultConfig.autoSave.async,path:l=defaultConfig.autoSave.path,name:u=defaultConfig.autoSave.name}=defaultConfig.autoSave}=defaultConfig){return(e,t,f)=>{if("OPTIONS"===e.method)f();else{let t=!1,i=Buffer.from([]);const n=e.headers["content-type"],a=-1!==n.indexOf("boundary=")?"--"+n.split("boundary=")[1]:void 0;e.on("data",e=>{i.length>o?t=!0:i=Buffer.concat([i,e])}),e.on("end",()=>{t?f(new Error("文件大小超过限制，通过设置maxSize以调整限制")):(e.files=e.files||[],e.body=e.body||{},a?convertMutiFiles(i,a).forEach(collatingInfo(e)):e.body=JSON.parse(i.toString()),r&&saveFiles(e.files,l,u,s),f())})}}}function saveFiles(e,f,{prefix:n,suffix:a,useMd5:o},r){fs.existsSync(f)||fs.mkdirSync(f),e.forEach(e=>{var t=""+n+(o?""+countHash(e.fileBuffer):e.fileMeta.prefix)+a+"."+e.fileMeta.suffix,i=path.join(f,t);if(r)fs.writeFile(i,e.fileBuffer,e=>{e&&console.log(e)});else try{fs.writeFileSync(i,e.fileBuffer)}catch(e){console.log(e)}e.saveMeta={fileName:t,filePath:i}})}function countHash(e){const t=crypto.createHash("md5");return t.update(e,"utf8"),t.digest("hex")}function collatingInfo(t){return e=>{e.fileMeta.fileName?t.files.push(e):t.body[e.fileMeta.name]?t.body[e.fileMeta.name]=[t.body[e.fileMeta.name],JSON.parse(e.fileBuffer.toString())]:t.body[e.fileMeta.name]=JSON.parse(e.fileBuffer.toString())}}function convertMutiFiles(e,t){const i=[],f=[],n=[],a=[];var o=Buffer.from(t);let r=e.indexOf(o);for(;-1!==r;){var s=e.indexOf("\r\n\r\n",r)+4;if(s-4==-1)break;f.push(e.slice(r,s-4)),r=e.indexOf(o,s),n.push(e.slice(s,r-2)),a.push(r-2-s)}return n.forEach((e,t)=>{i.push({fileMeta:Object.assign(Object.assign({},convertFileMeta(f[t])),{size:a[t]}),fileBuffer:e})}),i}function convertFileMeta(e){let t,i,f,n,a;const o=e.toString().split("\r\n");return t=o[1].substring(o[1].indexOf('name="')+6,o[1].indexOf('"',o[1].indexOf('name="')+7)),2!==o.length&&(i=o[1].substring(o[1].indexOf('filename="')+10,o[1].indexOf('"',o[1].indexOf('filename="')+11)),f=null==(e=o[2])?void 0:e.substring(o[2].indexOf("Content-Type: ")+14),n=null===i||void 0===i?void 0:i.split(".").at(-1),a=null===i||void 0===i?void 0:i.substring(0,null===i||void 0===i?void 0:i.lastIndexOf("."))),{name:t,fileName:i,contentType:f,suffix:n,prefix:a}}export default receiveFormData;